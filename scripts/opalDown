#!/usr/bin/env bash
set -euo pipefail

BASE_DIR="$HOME/Opal"
RESET=false

usage() {
  cat <<'USAGE'
Usage: opalDown [-r|--reset]

-r, --reset   Also delete volumes
USAGE
}

case "${1:-}" in
  "") ;;
  -r|--reset) RESET=true ;;
  -h|--help) usage; exit 0 ;;
  *)
    echo "Unknown option: ${1}" >&2
    usage >&2
    exit 2
    ;;
esac

if [[ ! -d "$BASE_DIR" ]]; then
  echo "Base directory not found: $BASE_DIR" >&2
  exit 1
fi

cd "$BASE_DIR"

DOWN_ARGS=(down)
if [[ "$RESET" == "true" ]]; then
  DOWN_ARGS+=( -v )
fi

COMPOSE_FILES=(
  -f "$BASE_DIR/opal-fines-service/docker-compose.base.yml"
  -f "$BASE_DIR/opal-fines-service/docker-compose.local.yml"
  -f "$BASE_DIR/opal-user-service/docker-compose.base.yml"
  -f "$BASE_DIR/opal-user-service/docker-compose.local.yml"
  -f "$BASE_DIR/opal-logging-service/docker-compose.base.yml"
  -f "$BASE_DIR/opal-logging-service/docker-compose.local.yml"
)

PROJECT=opal-stack

docker compose -p "$PROJECT" \
  "${COMPOSE_FILES[@]}" \
  "${DOWN_ARGS[@]}" || true

